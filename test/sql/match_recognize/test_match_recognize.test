# name: test/sql/match_recognize/test_match_recognize.test
# description: Test multi column reference
# group: [match_recognize]

# later...
# statement ok
# PRAGMA enable_verification

statement ok
pragma threads=1;

statement ok
create table test (p integer, o integer, v double, v2 double);

statement ok
insert into test values (1, 3, 1.3, 10.3), (1, 1, 1.1, 10.1), (1, 2, 1.2, 10.2),  (2, 2, 2.2, 20.2), (2, 1, 2.1, 20.1),  (2, 3, 2.3, 20.3);

query IIII
SELECT p, o, __match_recognize_fun.match_start, __match_recognize_fun.match_end
FROM test MATCH_RECOGNIZE(
    PARTITION BY p
    ORDER BY o
    MEASURES A.v AS a_val, B.v as b_val
    ALL ROWS PER MATCH
    AFTER MATCH SKIP TO LAST B
    PATTERN (A B)
    DEFINE A as (v-1) > 0.11, B as (v2-10) > 0.2
)
ORDER BY p,o
----
1	1	0	0
1	2	0	1
1	3	0	2
2	1	0	0
2	2	0	1
2	3	0	2

query IIII
SELECT s.p, s.o, s.__match_recognize_fun.match_start, s.__match_recognize_fun.match_end
FROM test AS t MATCH_RECOGNIZE(
    PARTITION BY p
    ORDER BY o
    MEASURES A.v AS a_val, B.v as b_val
    ONE ROW PER MATCH
    AFTER MATCH SKIP TO NEXT ROW
    PATTERN (A B)
    DEFINE A as (v-1) > 0.11, B as (v2-10) > 0.2
) AS s
ORDER BY s.p,s.o
----
1	1	0	0
1	2	0	1
1	3	0	2
2	1	0	0
2	2	0	1
2	3	0	2


# pattern parsing tests, ignore the stuff around
statement ok
SELECT COUNT(*)
FROM test AS t MATCH_RECOGNIZE(
    MEASURES A.v AS a_val
    PATTERN (A+ B* C{1,2} D{3,} E{,4})
    DEFINE A as (v-1) > 0.11,  B as (v-1) > 0.11,  C as (v-1) > 0.11,  D as (v-1) > 0.11,  E as (v-1) > 0.11
) AS s

statement ok
SELECT COUNT(*)
FROM test AS t MATCH_RECOGNIZE(
    MEASURES A.v AS a_val
    PATTERN ((A (B C)))
    DEFINE A as (v-1) > 0.11,  B as (v-1) > 0.11,  C as (v-1) > 0.11,  D as (v-1) > 0.11,  E as (v-1) > 0.11
) AS s

statement ok
SELECT COUNT(*)
FROM test AS t MATCH_RECOGNIZE(
    MEASURES A.v AS a_val
    PATTERN ((A (B C)*){1,2})
    DEFINE A as (v-1) > 0.11,  B as (v-1) > 0.11,  C as (v-1) > 0.11,  D as (v-1) > 0.11,  E as (v-1) > 0.11
) AS s


statement ok
SELECT COUNT(*)
FROM test AS t MATCH_RECOGNIZE(
    MEASURES A.v AS a_val
    PATTERN (A | B)
    DEFINE A as (v-1) > 0.11,  B as (v-1) > 0.11,  C as (v-1) > 0.11,  D as (v-1) > 0.11,  E as (v-1) > 0.11
) AS s



statement error # second quantifier value cant be smaller than first one
SELECT COUNT(*)
FROM test AS t MATCH_RECOGNIZE(
    MEASURES A.v AS a_val
    PATTERN (A+ B* C{2,1} D{3,} E{,4})
    DEFINE A as (v-1) > 0.11,  B as (v-1) > 0.11,  C as (v-1) > 0.11,  D as (v-1) > 0.11,  E as (v-1) > 0.11
) AS s
----

mode skip

query II
explain from test MATCH_RECOGNIZE(
    PARTITION BY p
    ORDER BY o
    MEASURES A.v AS a_val, B.v as b_val
    PATTERN (A B)
    DEFINE A as v/10 > 0.12 , B as (v2-10)/10 > 0.22)
----
